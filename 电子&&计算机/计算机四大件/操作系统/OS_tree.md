# 操作系统知识树

## 一、操作系统基础概念

### 1.1 操作系统定义与目标

- **定义**：控制和管理计算机硬件 / 软件资源，为用户和应用程序提供接口的系统软件

- **核心目标**

- 资源管理（CPU、内存、IO 设备、文件）

- 提供抽象接口（隐藏硬件细节，如文件系统 API）

- 保证系统安全与稳定

- 提高资源利用率和系统吞吐量

### 1.2 操作系统基本功能

#### 1.2.1 进程管理

- 进程创建 / 撤销 / 调度

- 进程间通信（IPC）与同步

#### 1.2.2 内存管理

- 内存分配与回收

- 虚拟内存管理

- 内存保护与共享

#### 1.2.3 文件系统

- 文件存储与组织

- 目录管理

- 磁盘空间分配与回收

#### 1.2.4 设备管理

- 设备驱动程序管理

- IO 调度与缓冲技术

- 中断处理与 DMA 控制

#### 1.2.5 作业管理（批处理系统）

- 作业调度与进程调度分级

- 作业控制语言（JCL）解析

### 1.3 操作系统发展历史

1. **手工操作阶段（1940s）**

- 纸带 / 卡片输入，人机直接交互，无操作系统

2. **批处理系统（1950s-1960s）**

- 单道批处理（一次处理一个作业）

- 多道批处理（CPU 与 IO 设备并行，如 IBM OS/360）

3. **分时系统（1960s-1970s）**

- 时间片轮转（如 CTSS、UNIX），支持多用户同时交互

4. **实时系统（1970s 至今）**

- 硬实时（航空控制系统，严格时间约束）

- 软实时（多媒体系统，最佳努力满足时间要求）

5. **现代操作系统（1980s 至今）**

- 微内核（Windows NT、Mach）与宏内核（Linux、FreeBSD）

- 分布式系统（Google Borg、Kubernetes）

## 二、进程与线程管理

### 2.1 进程概念

- **定义**：程序的一次执行实例，系统资源分配的基本单位

- **组成**

- 进程控制块（PCB）：存储进程状态、优先级、资源占用等信息

- 程序段：可执行代码

- 数据段：程序运行时的数据空间

- **状态转换**

```
运行态 <-> 就绪态（调度器切换）  运行态 -> 阻塞态（等待IO或事件）  阻塞态 -> 就绪态（事件完成）  
```

### 2.2 进程调度算法

#### 2.2.1 先来先服务（FCFS）

- **优点**：实现简单，公平

- **缺点**：长作业导致短作业等待时间长

- **示例**：作业队列 [10ms, 1ms]，平均周转时间 =(10+11)/2=10.5ms

#### 2.2.2 短作业优先（SJF）

- **优点**：最小化平均等待时间

- **缺点**：可能导致长作业饿死

- **抢占式变种**：短进程优先（SPF），新短作业到达时抢占

#### 2.2.3 时间片轮转（RR）

- **核心**：每个进程分配固定时间片（如 20ms），时间到则切换

- **应用**：分时系统（如 Linux 早期调度器）

- **时间片设置**：过小导致上下文切换开销大，过大退化为 FCFS

#### 2.2.4 优先级调度

- **静态优先级**：进程创建时确定（如系统进程优先级高于用户进程）

- **动态优先级**：根据运行时间或资源占用动态调整（如老化技术防止饿死）

### 2.3 进程同步与互斥

#### 2.3.1 临界资源与临界区

- 临界资源：一次仅允许一个进程访问的资源（如打印机、共享变量）

- 临界区：访问临界资源的代码段

- **互斥条件**：进入临界区前需获取锁，离开时释放

#### 2.3.2 同步机制

- **硬件指令**

- 测试并设置（Test-and-Set）

- 交换指令（Swap）

- **软件算法**

- Peterson 算法：解决两进程互斥问题

- **信号量（Semaphore）**

- 二元信号量（互斥锁）：wait()和signal()操作

- 计数信号量（资源分配）：如sem_init(&room, 0, 10)表示 10 个可用资源

- **管程（Monitor）**

- 封装共享数据和操作，保证互斥进入（如 Java 的synchronized关键字）

### 2.4 线程（Thread）

- **定义**：进程内的执行单元，系统调度的基本单位

- **优点**

- 轻量级：共享进程资源，上下文切换开销小

- 并行性：多线程程序可利用多核 CPU

- **分类**

- 用户级线程（ULT）：由语言运行时管理（如 Java 线程）

- 内核级线程（KLT）：由操作系统调度（如 POSIX 线程 pthread）

- **线程安全**：访问共享资源时需加锁（如互斥量、读写锁）

## 三、内存管理

### 3.1 内存管理基础

- **内存空间**

- 物理内存：实际硬件存储单元

- 虚拟内存：进程看到的逻辑地址空间（如 32 位系统 4GB 虚拟地址）

- **地址转换**：虚拟地址 → 物理地址（通过页表或段表）

### 3.2 内存分配策略

#### 3.2.1 连续分配

- **单一分区分配**：早期单任务系统（如 MS-DOS），内存分为系统区和用户区

- **固定分区分配**：将内存划分为多个固定大小分区，每个分区容纳一个进程

- **动态分区分配**

- 首次适应（First Fit）：找到第一个足够大的空闲块

- 最佳适应（Best Fit）：找最小的足够大空闲块（可能产生大量碎片）

- 最坏适应（Worst Fit）：找最大空闲块，减少碎片

#### 3.2.2 非连续分配

- **分页管理**

- 页（Page）：虚拟内存划分为固定大小块（如 4KB）

- 页帧（Frame）：物理内存对应块

- 页表（Page Table）：记录页号到页帧号的映射

- 快表（TLB）：缓存最近访问的页表项，加速地址转换

- **分段管理**

- 段（Segment）：逻辑上独立的地址空间（如代码段、数据段、堆栈段）

- 段表（Segment Table）：记录段基址和段长度

- **段页式管理**：结合分段和分页，先分段再分页

### 3.3 虚拟内存技术

- **核心思想**：程序无需全部装入内存即可运行，不常用页面交换到磁盘

- **实现方式**

- 请求分页（Demand Paging）：缺页时从磁盘调入

- 页面置换算法

- 最优置换（OPT）：置换未来最远使用的页面（理论最优，无法实现）

- 最近最少使用（LRU）：置换最长时间未访问的页面（通过页表项访问位实现）

- 最近未使用（NRU）：根据访问位和修改位简单分类置换

- 页面分配策略

- 固定分配局部置换：为进程分配固定数量页框，缺页时仅在本进程内置换

- 可变分配全局置换：可从所有进程回收页框，动态调整分配数量

- **缺页中断**：访问未装入内存的页面时触发，操作系统负责调入页面

## 四、文件系统

### 4.1 文件与文件系统

- **文件定义**：具有符号名的、在逻辑上具有完整意义的一组相关信息项的有序序列

- **文件属性**

- 元数据：文件名、大小、创建时间、访问权限

- 数据内容：二进制数据或文本

- **文件系统功能**

- 文件存储与检索

- 目录管理（树状结构，如/usr/local/bin）

- 磁盘空间管理（块分配、碎片整理）

### 4.2 文件结构与组织

#### 4.2.1 文件逻辑结构

- **无结构文件**：流式文件（如文本文件，Linux 一切皆文件）

- **有结构文件**

- 记录式文件：定长记录 / 变长记录（如数据库表）

- 树状结构文件：XML/JSON 格式

#### 4.2.2 文件物理结构

- **顺序结构**：文件数据连续存储（如磁带存储，适合顺序访问）

- **链接结构**

- 隐式链接：每个块存储下一块地址（如 FAT 文件系统）

- 显式链接：文件分配表（FAT）记录所有块链接关系

- **索引结构**

- 单级索引：文件目录项包含索引块地址，索引块存储所有数据块地址

- 多级索引：如 Linux inode 的间接块（12 直接块 + 1 间接块 + 1 双间接块 + 1 三间接块）

### 4.3 目录管理

- **目录结构**

- 单级目录：所有文件在同一目录（早期系统，易重名）

- 二级目录：用户目录 + 系统目录（如 Windows 早期）

- 树状目录：层次化结构（如 Unix/Linux，根目录/下分多级子目录）

- 无环图目录：允许文件 / 目录被多个路径引用（如硬链接）

- **目录操作**

- 创建 / 删除目录

- 打开 / 关闭文件

- 路径解析（绝对路径/home/user/file vs 相对路径../file）

### 4.4 磁盘管理

- **磁盘结构**

- 盘面（Platter）、磁道（Track）、扇区（Sector，通常 512 字节）

- 柱面（Cylinder）：所有盘面上相同磁道号的磁道集合

- **磁盘调度算法**

- 先来先服务（FCFS）：按请求顺序处理（性能差）

- 最短寻道时间优先（SSTF）：优先处理离当前磁头最近的请求（可能导致饥饿）

- 扫描算法（SCAN）：磁头双向扫描，如电梯调度（往返于磁盘两端）

- 循环扫描（CSCAN）：单向扫描，返回时直接跳到起始端

- **磁盘格式化**

- 低级格式化：划分扇区，记录坏块信息

- 分区：创建主分区 / 扩展分区

- 逻辑格式化：创建文件系统（如 FAT32、NTFS、EXT4）

## 五、设备管理

### 5.1 设备分类

- **按传输速率**

- 低速设备：键盘、鼠标

- 中速设备：打印机、扫描仪

- 高速设备：磁盘、网卡

- **按使用特性**

- 独占设备：一次仅允许一个进程访问（如打印机）

- 共享设备：可被多个进程同时访问（如磁盘）

- 虚拟设备：通过 SPOOLing 技术将独占设备虚拟为共享设备（如虚拟打印机）

### 5.2 IO 控制方式

#### 5.2.1 程序查询方式

- **流程**：CPU 不断查询设备状态，直到 IO 完成

- **缺点**：CPU 利用率低，适合低速设备（如早期纸带输入机）

#### 5.2.2 中断方式

- **流程**：CPU 发起 IO 请求后继续执行，设备完成时发送中断信号

- **优点**：CPU 与 IO 设备并行工作

- **中断处理流程**：保存现场 → 执行中断服务程序（ISR） → 恢复现场

#### 5.2.3 DMA 方式

- **直接内存访问**：DMA 控制器负责数据传输，无需 CPU 干预

- **适用场景**：高速块设备（如磁盘），一次传输多个数据块

#### 5.2.4 通道方式

- **通道**：专用 IO 处理器，可执行通道程序

- **优点**：支持多设备并行 IO，减轻 CPU 负担

- **典型应用**：大型主机系统（如 IBM 大型机）

### 5.3 缓冲技术

- **单缓冲**：设备与 CPU 之间设置一个缓冲区（如打印机缓冲）

- **双缓冲**：输入输出各一个缓冲区，交替使用（如管道通信）

- **循环缓冲**：多个缓冲区组成循环队列，适合连续数据传输（如视频流）

- **缓冲池**：多个缓冲区共享，根据需求动态分配（如 Linux 内核缓冲池）

## 六、死锁（Deadlock）

### 6.1 死锁定义与必要条件

- **定义**：多个进程因竞争资源而形成的互相等待状态

- **必要条件**

1. 互斥条件：资源被独占占用

2. 请求与保持条件：进程持有资源并请求其他资源

3. 不可剥夺条件：资源只能由持有进程主动释放

4. 循环等待条件：存在进程 - 资源循环等待链

### 6.2 死锁处理策略

#### 6.2.1 死锁预防

- 破坏必要条件

- 互斥条件：无法破坏（某些资源必须互斥）

- 请求与保持：进程启动时一次性申请所有资源（如银行系统转账前锁定两个账户）

- 不可剥夺：允许抢占资源（如优先级高的进程抢占打印机）

- 循环等待：为资源编号，进程按顺序申请（如先申请打印机再申请扫描仪）

#### 6.2.2 死锁避免

- **银行家算法（Banker's Algorithm）**

- **数据结构**

- 可用资源向量Available

- 最大需求矩阵Max

- 分配矩阵Allocation

- 需求矩阵Need = Max - Allocation

- **安全状态检查**：模拟资源分配，判断是否存在安全序列（如P1→P3→P2）

- **示例**：进程 P1 申请 2 个资源，系统检查Need[P1] ≤ Available，且分配后存在安全序列则允许

#### 6.2.3 死锁检测与解除

- **死锁检测算法**

- 构建资源分配图，检测是否存在环

- **解除方法**

- 抢占资源：选择代价最小的进程抢占资源

- 终止进程：强制终止一个或多个死锁进程（如 Linux 的kill命令）

## 七、并发与并行

### 7.1 并发 vs 并行

- **并发**：多个进程在同一时间段内交替执行（单核 CPU，宏观并行，微观串行）

- **并行**：多个进程在同一时刻同时执行（多核 CPU，真正的同时执行）

### 7.2 多核调度问题

- **缓存一致性**：多个 CPU 核心访问共享内存时的缓存同步（如 MESI 协议）

- **负载均衡**：避免核心空闲或过载（如 Linux 的 CFS 调度器支持负载迁移）

- **NUMA 架构**：非统一内存访问，进程绑定到本地内存区域提高访问速度

## 八、存储管理进阶

### 8.1 内存保护

- **硬件机制**

- 基址寄存器（Base Register）与限长寄存器（Limit Register）：检查地址是否越界

- 页表访问权限位：标记页面是否可读 / 写 / 执行（如 Linux 的页表项权限位）

- **软件机制**

- 访问控制列表（ACL）：文件级权限管理（如 Unix 的chmod命令）

### 8.2 内存泄漏与溢出

- **内存泄漏**：动态分配的内存未释放（如 C 语言忘记free()，Java 可通过 GC 回收部分泄漏）

- **内存溢出**：申请内存超过系统可用内存（如malloc(1GB)在剩余 500MB 的系统中失败）

## 九、操作系统体系结构

### 9.1 宏内核（Monolithic Kernel）

- **特点**：所有服务（进程管理、文件系统、设备驱动）运行在内核态

- **优点**：效率高（函数直接调用）

- **缺点**：内核代码庞大，稳定性差（如早期 Linux 内核）

### 9.2 微内核（Micro Kernel）

- **特点**：内核仅包含最小必要功能（进程调度、内存管理、通信机制）

- **优点**：模块化，易扩展（如 Windows NT、MacOS 内核）

- **缺点**：用户态与内核态通信开销大

### 9.3 混合内核（Hybrid Kernel）

- **折中方案**：关键服务在内核态，非关键服务在用户态（如 Linux 2.6 + 内核，部分驱动运行在用户态）

## 十、经典操作系统分析

### 10.1 Unix/Linux

- **内核架构**：宏内核，支持模块动态加载（如insmod命令）

- **文件系统**：EXT4（支持大文件、日志功能）

- **调度器**：完全公平调度器（CFS），基于红黑树管理就绪进程

### 10.2 Windows

- **内核模式**：用户态（Ring3）与内核态（Ring0）分离

- **内存管理**：虚拟内存 + 页面文件（pagefile.sys）

- **进程调度**：抢占式优先级调度，动态调整线程优先级

### 10.3 嵌入式操作系统（如 VxWorks）

- **特点**：实时性强，内存占用小

- **应用场景**：航空航天、工业控制

- **调度算法**：固定优先级抢占调度

## 十一、操作系统安全

### 11.1 访问控制

- **自主访问控制（DAC）**：用户自主设置文件权限（如 Unix 的chown/chmod）

- **强制访问控制（MAC）**：系统强制规定访问策略（如 SELinux 的多级安全模型）

### 11.2 认证与加密

- **用户认证**：密码、生物识别、双因素认证

- **数据加密**：磁盘加密（如 BitLocker）、传输加密（如 HTTPS）

## 十二、操作系统发展趋势

### 12.1 新兴技术影响

- **容器技术（Docker）**：轻量级虚拟化，共享内核

- ** unikernel**：单地址空间操作系统，专为特定应用设计

- **边缘计算**：分布式操作系统，支持低延迟设备协同

### 12.2 研究热点

- 分布式系统一致性协议（Paxos、Raft）

- 内存计算（如 Redis 基于内存的键值存储）

- 能效优化（动态电压频率调整 DVFS）